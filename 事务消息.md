### 什么是事务消息
分布式事务消息解决的问题。分布式消息队列用来解耦多个微服务之间的调用耦合，不会因为单个服务的服务质量问题而影响其他业务。
比如电商场景下，一笔订单支付成功后可能要通过多个系统，如erp系统准备发货，商品系统扣减库存等等，这中间如果使用消息队列来解决可能存在2种情况：   
- 先发消息，后更新订单状态
- 先更新订单状态，后发消息。   
在第一种情况下，如果订单更新时出现问题发生了回滚，消息已经发送出去了，下游系统可能会出错。   
在第二种情况下，如果订单更新后，发送消息前因为系统宕机导致消息没发出去，则下游系统就不知道订单的最新状态。   
RocketMQ的事务消息就是为了解决上面的问题，它将消息和订单状态更新这两步操作放到一个事务中，要么都成功，没有都失败。   

### RocketMQ事务消息的实现原理
##### 事务消息的几个概念   
- **本地事务：** 用户实现的业务逻辑，比如更新订单状态的逻辑，本地事务执行返回的结果可能有三种状态：`COMMIT,代表本地业务逻辑执行成功，
这种情况下消息应该发出去`、`ROLLBACK本地业务逻辑执行失败，消息不该发出去`、`UNKNOW未知状态，可能是事务正在执行中出现了异常等，
这个情况下消息系统不知道该如何处理，当前的逻辑是会直接丢弃，等待后续检查逻辑来处理`。
- **Prepare消息：** RocketMQ在执行本地事务之前会先发一条Prepare消息到Broker，声名事务开始，但是Prepare消息不会发送给Consumer
- **Commit/Rollback消息：** 在本地事务执行结束之后，会根据本地事务的状态来决定发送commit/rollback消息，用于结束事务。Broker收到这条消息之后，如果是commit会把之前的Prepare消息真正投递给Consumer，如果是rollback不投递，存储三天后删除。

##### 事务消息交互流程
![事务消息交互流程](http://docs-aliyun.cn-hangzhou.oss.aliyun-inc.com/assets/pic/43348/cn_zh/1557378341241/%E4%BA%8B%E5%8A%A1%E6%B6%88%E6%81%AF.PNG)  

1.发送方向消息队列RocketMQ服务端发送消息   
2.服务端将消息持久化成功之后，向发送方ACK确认消息已经发送成功，此时消息为半消息   
3.发送方开始执行本地事务逻辑  
4.发送方根据本地事务执行结果向服务端提交了二次确认(commit or rollback),服务端收到commit状态则将半消息标记为可投递，订阅方最终将收到该消息；服务端收到Rollback状态则删除半消息，订阅方将不会接受该消息。  
5.在断网或者应用重启的特殊情况下，上述步骤4提交的二次确认最终未到达服务端，经过固定时间后服务端将对该消息发起消息回查。   
6.发送方收到消息回查之后，需要检查对应消息的本地事务执行的最终结果    
7.发送方根据检查得到的本地事务的最终状态再次提交二次确认，服务端仍然按照步骤4对半消息进行操作。   

















